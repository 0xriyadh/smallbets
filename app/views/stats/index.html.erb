<% @page_title = "Message Statistics" %>

<% content_for :nav do %>
  <div class="flex-item-justify-start flex gap">
    <%= link_back %>
    <%= link_to stats_path, class: "btn d-hotwire-native-none" do %>
      <%= image_tag("refresh.svg", aria: { hidden: "true" }, size: 20) %>
      <span class="for-screen-reader">Refresh stats</span>
    <% end %>
  </div>
<% end %>

<section class="full-width">
  <!-- Top Talkers Section -->
  <h2 class="section-heading">Top Talkers</h2>
  <div class="flex flex-wrap gap margin-block">
    <!-- Today's top talkers -->
    <div class="card flex-grow" style="min-width: 300px;">
      <div class="card-header">
        <h2 class="txt-h3 margin-none">Today</h2>
      </div>
      <div class="card-body compact">
        <div class="overflow-x-auto">
          <table class="table full-width">
            <tbody>
              <% @top_posters_today.first(10).each_with_index do |user, index| %>
                <% is_current = user.id == Current.user&.id %>
                <tr class="<%= 'current-user' if is_current %>">
                  <td class="txt-right txt-small txt-faded" style="width: 20px;"><%= index + 1 %></td>
                  <td>
                    <div class="flex gap-inline align-center">
                      <%= link_to user_path(user, from: "/stats"), class: "flex align-center hover-target", style: "text-decoration: none; gap: 4px; min-width: 0;" do %>
                        <% if user.avatar.attached? %>
                          <div class="avatar avatar-xs">
                            <%= image_tag user.avatar, alt: user.name, loading: "lazy" %>
                          </div>
                        <% else %>
                          <div class="avatar avatar-xs">
                            <%= user.name.first.upcase %>
                          </div>
                        <% end %>
                        <span class="txt-truncate"><%= user.name %></span>
                      <% end %>
                    </div>
                  </td>
                  <td class="txt-right">
                    <%= number_with_delimiter(user.message_count) %>
                  </td>
                </tr>
              <% end %>
              <% if Current.user && @current_user_today_stats %>
                <tr>
                  <td colspan="3" class="txt-center txt-small txt-faded" style="padding: 0.25rem;">
                    <div style="border-top: 1px dashed var(--color-border-darker); margin: 0.25rem 0;"></div>
                  </td>
                </tr>
                <tr class="current-user">
                  <td class="txt-right txt-small txt-faded" style="width: 20px;"><%= @current_user_today_rank %></td>
                  <td>
                    <div class="flex gap-inline align-center">
                      <%= link_to user_path(Current.user, from: "/stats"), class: "flex align-center hover-target", style: "text-decoration: none; gap: 4px; min-width: 0;" do %>
                        <% if Current.user.avatar.attached? %>
                          <div class="avatar avatar-xs">
                            <%= image_tag Current.user.avatar, alt: Current.user.name, loading: "lazy" %>
                          </div>
                        <% else %>
                          <div class="avatar avatar-xs">
                            <%= Current.user.name.first.upcase %>
                          </div>
                        <% end %>
                        <span class="txt-truncate"><%= Current.user.name %></span>
                      <% end %>
                    </div>
                  </td>
                  <td class="txt-right">
                    <%= number_with_delimiter(@current_user_today_stats.message_count) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- This month's top talkers -->
    <div class="card flex-grow" style="min-width: 300px;">
      <div class="card-header">
        <h2 class="txt-h3 margin-none">This Month</h2>
      </div>
      <div class="card-body compact">
        <div class="overflow-x-auto">
          <table class="table full-width">
            <tbody>
              <% @top_posters_month.first(10).each_with_index do |user, index| %>
                <% is_current = user.id == Current.user&.id %>
                <tr class="<%= 'current-user' if is_current %>">
                  <td class="txt-right txt-small txt-faded" style="width: 20px;"><%= index + 1 %></td>
                  <td>
                    <div class="flex gap-inline align-center">
                      <%= link_to user_path(user, from: "/stats"), class: "flex align-center hover-target", style: "text-decoration: none; gap: 4px; min-width: 0;" do %>
                        <% if user.avatar.attached? %>
                          <div class="avatar avatar-xs">
                            <%= image_tag user.avatar, alt: user.name, loading: "lazy" %>
                          </div>
                        <% else %>
                          <div class="avatar avatar-xs">
                            <%= user.name.first.upcase %>
                          </div>
                        <% end %>
                        <span class="txt-truncate"><%= user.name %></span>
                      <% end %>
                    </div>
                  </td>
                  <td class="txt-right">
                    <%= number_with_delimiter(user.message_count) %>
                  </td>
                </tr>
              <% end %>
              <% if Current.user && @current_user_month_stats %>
                <tr>
                  <td colspan="3" class="txt-center txt-small txt-faded" style="padding: 0.25rem;">
                    <div style="border-top: 1px dashed var(--color-border-darker); margin: 0.25rem 0;"></div>
                  </td>
                </tr>
                <tr class="current-user">
                  <td class="txt-right txt-small txt-faded" style="width: 20px;"><%= @current_user_month_rank %></td>
                  <td>
                    <div class="flex gap-inline align-center">
                      <%= link_to user_path(Current.user, from: "/stats"), class: "flex align-center hover-target", style: "text-decoration: none; gap: 4px; min-width: 0;" do %>
                        <% if Current.user.avatar.attached? %>
                          <div class="avatar avatar-xs">
                            <%= image_tag Current.user.avatar, alt: Current.user.name, loading: "lazy" %>
                          </div>
                        <% else %>
                          <div class="avatar avatar-xs">
                            <%= Current.user.name.first.upcase %>
                          </div>
                        <% end %>
                        <span class="txt-truncate"><%= Current.user.name %></span>
                      <% end %>
                    </div>
                  </td>
                  <td class="txt-right">
                    <%= number_with_delimiter(@current_user_month_stats.message_count) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- This year's top talkers -->
    <div class="card flex-grow" style="min-width: 300px;">
      <div class="card-header">
        <h2 class="txt-h3 margin-none">This Year</h2>
      </div>
      <div class="card-body compact">
        <div class="overflow-x-auto">
          <table class="table full-width">
            <tbody>
              <% @top_posters_year.first(10).each_with_index do |user, index| %>
                <% is_current = user.id == Current.user&.id %>
                <tr class="<%= 'current-user' if is_current %>">
                  <td class="txt-right txt-small txt-faded" style="width: 20px;"><%= index + 1 %></td>
                  <td>
                    <div class="flex gap-inline align-center">
                      <%= link_to user_path(user, from: "/stats"), class: "flex align-center hover-target", style: "text-decoration: none; gap: 4px; min-width: 0;" do %>
                        <% if user.avatar.attached? %>
                          <div class="avatar avatar-xs">
                            <%= image_tag user.avatar, alt: user.name, loading: "lazy" %>
                          </div>
                        <% else %>
                          <div class="avatar avatar-xs">
                            <%= user.name.first.upcase %>
                          </div>
                        <% end %>
                        <span class="txt-truncate"><%= user.name %></span>
                      <% end %>
                    </div>
                  </td>
                  <td class="txt-right">
                    <%= number_with_delimiter(user.message_count) %>
                  </td>
                </tr>
              <% end %>
              <% if Current.user && @current_user_year_stats %>
                <tr>
                  <td colspan="3" class="txt-center txt-small txt-faded" style="padding: 0.25rem;">
                    <div style="border-top: 1px dashed var(--color-border-darker); margin: 0.25rem 0;"></div>
                  </td>
                </tr>
                <tr class="current-user">
                  <td class="txt-right txt-small txt-faded" style="width: 20px;"><%= @current_user_year_rank %></td>
                  <td>
                    <div class="flex gap-inline align-center">
                      <%= link_to user_path(Current.user, from: "/stats"), class: "flex align-center hover-target", style: "text-decoration: none; gap: 4px; min-width: 0;" do %>
                        <% if Current.user.avatar.attached? %>
                          <div class="avatar avatar-xs">
                            <%= image_tag Current.user.avatar, alt: Current.user.name, loading: "lazy" %>
                          </div>
                        <% else %>
                          <div class="avatar avatar-xs">
                            <%= Current.user.name.first.upcase %>
                          </div>
                        <% end %>
                        <span class="txt-truncate"><%= Current.user.name %></span>
                      <% end %>
                    </div>
                  </td>
                  <td class="txt-right">
                    <%= number_with_delimiter(@current_user_year_stats.message_count) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- All time top talkers -->
    <div class="card flex-grow" style="min-width: 300px;">
      <div class="card-header">
        <h2 class="txt-h3 margin-none">All Time</h2>
      </div>
      <div class="card-body compact">
        <div class="overflow-x-auto">
          <table class="table full-width">
            <tbody>
              <% @top_posters_all_time.first(10).each_with_index do |user, index| %>
                <% is_current = user.id == Current.user&.id %>
                <tr class="<%= 'current-user' if is_current %>">
                  <td class="txt-right txt-small txt-faded" style="width: 20px;"><%= index + 1 %></td>
                  <td>
                    <div class="flex gap-inline align-center">
                      <%= link_to user_path(user, from: "/stats"), class: "flex align-center hover-target", style: "text-decoration: none; gap: 4px; min-width: 0;" do %>
                        <% if user.avatar.attached? %>
                          <div class="avatar avatar-xs">
                            <%= image_tag user.avatar, alt: user.name, loading: "lazy" %>
                          </div>
                        <% else %>
                          <div class="avatar avatar-xs">
                            <%= user.name.first.upcase %>
                          </div>
                        <% end %>
                        <span class="txt-truncate"><%= user.name %></span>
                      <% end %>
                    </div>
                  </td>
                  <td class="txt-right">
                    <%= number_with_delimiter(user.message_count) %>
                  </td>
                </tr>
              <% end %>
              <% if Current.user && @current_user_all_time_stats %>
                <tr>
                  <td colspan="3" class="txt-center txt-small txt-faded" style="padding: 0.25rem;">
                    <div style="border-top: 1px dashed var(--color-border-darker); margin: 0.25rem 0;"></div>
                  </td>
                </tr>
                <tr class="current-user">
                  <td class="txt-right txt-small txt-faded" style="width: 20px;"><%= @current_user_all_time_rank %></td>
                  <td>
                    <div class="flex gap-inline align-center">
                      <%= link_to user_path(Current.user, from: "/stats"), class: "flex align-center hover-target", style: "text-decoration: none; gap: 4px; min-width: 0;" do %>
                        <% if Current.user.avatar.attached? %>
                          <div class="avatar avatar-xs">
                            <%= image_tag Current.user.avatar, alt: Current.user.name, loading: "lazy" %>
                          </div>
                        <% else %>
                          <div class="avatar avatar-xs">
                            <%= Current.user.name.first.upcase %>
                          </div>
                        <% end %>
                        <span class="txt-truncate"><%= Current.user.name %></span>
                      <% end %>
                    </div>
                  </td>
                  <td class="txt-right">
                    <%= number_with_delimiter(@current_user_all_time_stats.message_count) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Other Stats Section -->
  <h2 class="section-heading" style="margin-top: 2rem;">Stats</h2>
  <div class="flex flex-wrap gap margin-block">
    <!-- Stats summary -->
    <div class="card flex-grow" style="min-width: 300px;">
      <div class="card-header">
        <h2 class="txt-h3 margin-none">Metrics</h2>
      </div>
      <div class="card-body compact">
        <div class="overflow-x-auto">
          <table class="table full-width">
            <tbody>
              <tr>
                <td>Members</td>
                <td class="txt-right"><%= number_with_delimiter(@total_users) %></td>
              </tr>
              <tr>
                <td>Online</td>
                <td class="txt-right"><%= number_with_delimiter(@online_users) %></td>
              </tr>
              <tr>
                <td>Posters</td>
                <td class="txt-right"><%= number_with_delimiter(@total_posters) %></td>
              </tr>
              <tr>
                <td>Messages</td>
                <td class="txt-right"><%= number_with_delimiter(@total_messages) %></td>
              </tr>
              <tr>
                <td>Boosts</td>
                <td class="txt-right"><%= number_with_delimiter(@total_boosts) %></td>
              </tr>
              <tr>
                <td>Database</td>
                <td class="txt-right"><%= number_to_human_size(@database_size) %></td>
              </tr>
              <% if @cpu_util && @cpu_cores %>
              <tr>
                <td>CPU</td>
                <td class="txt-right"><%= number_to_percentage(@cpu_util, precision: 1) %> of <%= @cpu_cores %> CPUs</td>
              </tr>
              <% end %>
              <% if @free_memory_percent && @total_memory_gb %>
              <tr>
                <td>Memory</td>
                <td class="txt-right"><%= number_to_percentage(@memory_util_percent, precision: 0) %> of <%= @total_memory_gb.to_i %>GB</td>
              </tr>
              <% end %>
              <% if @free_disk_percent && @total_disk_gb %>
              <tr>
                <td>Disk</td>
                <td class="txt-right"><%= number_to_percentage(@disk_util_percent, precision: 0) %> of <%= @total_disk_gb.to_i %>GB</td>
              </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Newest members -->
    <div class="card flex-grow" style="min-width: 300px;">
      <div class="card-header">
        <h2 class="txt-h3 margin-none">Newest Members</h2>
      </div>
      <div class="card-body compact">
        <div class="overflow-x-auto">
          <table class="table full-width">
            <tbody>
              <% @newest_members.first(10).each_with_index do |user, index| %>
                <% is_current = user.id == Current.user&.id %>
                <tr class="<%= 'current-user' if is_current %>">
                  <td class="txt-right txt-small txt-faded" style="width: 20px;"><%= index + 1 %></td>
                  <td>
                    <div class="flex gap-inline align-center">
                      <%= link_to user_path(user, from: "/stats"), class: "flex align-center hover-target", style: "text-decoration: none; gap: 4px; min-width: 0;" do %>
                        <% if user.avatar.attached? %>
                          <div class="avatar avatar-xs">
                            <%= image_tag user.avatar, alt: user.name, loading: "lazy" %>
                          </div>
                        <% else %>
                          <div class="avatar avatar-xs">
                            <%= user.name.first.upcase %>
                          </div>
                        <% end %>
                        <span class="txt-truncate"><%= user.name %></span>
                      <% end %>
                    </div>
                  </td>
                  <td class="txt-right">
                    <%= user.joined_at.strftime("%Y-%m-%d") %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Daily stats table with graph -->
    <div class="card flex-grow" style="min-width: 500px;">
      <div class="card-header">
        <h2 class="txt-h3 margin-none">Messages</h2>
      </div>
      <div class="card-body compact">
        <!-- Table data -->
        <div class="overflow-x-auto">
          <table class="table full-width">
            <tbody>
              <% @daily_stats.first(7).each do |stat| %>
                <tr>
                  <td><%= stat.date %></td>
                  <td class="txt-right"><%= number_with_delimiter(stat.count) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        
        <!-- Graph visualization -->
        <div class="margin-top">
          <div style="height: 300px;">
            <%
              # Use all-time stats
              max_count = @all_time_stats.map(&:count).max
              total_days = @all_time_stats.length
              
              # Fixed dimensions
              graph_height = 240
              left_margin = 8
              right_margin = 2
              bottom_margin = 25
              
              # Calculate bar width and spacing
              available_width = 100 - left_margin - right_margin
              min_bar_width = 0.15
              bar_spacing = 0.05
              bar_width = [(available_width - (total_days * bar_spacing)) / total_days, min_bar_width].max
              
              # Show fewer labels for readability
              label_interval = (total_days / 6.0).ceil
            %>

            <svg width="100%" height="100%" style="background: var(--color-bg); border-radius: 4px;">
              <!-- Y-axis labels -->
              <% 
                # Calculate y-axis ticks at 100 message intervals
                y_ticks = (0..max_count).step(100).to_a
                
                # Only add max if it's significantly different from the last tick
                last_tick = y_ticks.last
                if (max_count - last_tick) > 50
                  y_ticks << max_count
                end
                
                # Remove any ticks that are too close together
                y_ticks = y_ticks.each_with_index.reject do |tick, i|
                  next_tick = y_ticks[i + 1]
                  next_tick && (next_tick - tick) < 50
                end.map(&:first)
              %>

              <!-- Horizontal grid lines -->
              <% y_ticks.each do |tick| %>
                <% y_pos = (graph_height - bottom_margin) - (tick.to_f / max_count * (graph_height - bottom_margin - 10)) %>
                <line 
                  x1="<%= left_margin %>%" 
                  x2="<%= 100 - right_margin %>%" 
                  y1="<%= y_pos %>" 
                  y2="<%= y_pos %>" 
                  stroke="var(--color-border-darker)" 
                  stroke-width="1"
                  stroke-opacity="0.25"
                  stroke-dasharray="4,4"
                />
              <% end %>

              <% y_ticks.each do |tick| %>
                <% y_pos = (graph_height - bottom_margin) - (tick.to_f / max_count * (graph_height - bottom_margin - 10)) %>
                
                <!-- Tick mark -->
                <line 
                  x1="<%= left_margin - 0.5 %>%" 
                  x2="<%= left_margin %>%" 
                  y1="<%= y_pos %>" 
                  y2="<%= y_pos %>" 
                  stroke="var(--color-border-darker)" 
                  stroke-width="1"
                />
                
                <!-- Label -->
                <text 
                  x="<%= left_margin - 1 %>%" 
                  y="<%= y_pos + 4 %>" 
                  text-anchor="end"
                  style="font-size: 10px; fill: var(--color-text);"
                >
                  <%= number_with_delimiter(tick) %>
                </text>
              <% end %>

              <!-- Y-axis -->
              <line 
                x1="<%= left_margin %>%" 
                y1="10" 
                x2="<%= left_margin %>%" 
                y2="<%= graph_height - bottom_margin %>" 
                stroke="var(--color-border-darker)" 
                stroke-width="1"
              />

              <!-- Bars -->
              <% @all_time_stats.each_with_index do |stat, index| %>
                <% 
                  bar_height = (stat.count.to_f / max_count * (graph_height - bottom_margin - 10)).round
                  x_pos = left_margin + (index * (bar_width + bar_spacing))
                %>
                
                <rect 
                  x="<%= x_pos %>%" 
                  y="<%= graph_height - bottom_margin - bar_height %>" 
                  width="<%= bar_width %>%"
                  height="<%= bar_height %>"
                  fill="var(--color-border-darker)"
                />

                <!-- X-axis labels -->
                <% if index % label_interval == 0 %>
                  <text 
                    x="<%= x_pos %>%" 
                    y="<%= graph_height - 5 %>" 
                    text-anchor="start"
                    style="font-size: 10px; fill: var(--color-text);"
                    transform="rotate(-45, <%= x_pos %>%, <%= graph_height - 5 %>)"
                  >
                    <%= stat.date.split('-')[1..2].join('/') %>
                  </text>
                <% end %>
              <% end %>

              <!-- X-axis line -->
              <line 
                x1="<%= left_margin %>%" 
                y1="<%= graph_height - bottom_margin %>" 
                x2="<%= 100 - right_margin %>%" 
                y2="<%= graph_height - bottom_margin %>" 
                stroke="var(--color-border-darker)" 
                stroke-width="1"
              />
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .full-width {
    width: 100%;
    padding: 1rem;
    padding-top: 0.5rem; /* Minimal padding at the top */
  }
  
  .section-heading {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0.5rem 0 0.5rem 0; /* Reduced top margin to 0.5rem */
    padding-bottom: 0.5rem;
    clear: both; /* Ensures the heading doesn't get overlapped */
  }
  
  /* Fix for navigation overlap */
  #nav {
    position: relative;
    z-index: 10;
  }
  
  /* Ensure main content doesn't overlap with navigation */
  #main-content {
    position: relative;
    z-index: 1;
    padding-top: 0; /* Removed padding */
  }
  
  .card {
    background: var(--color-bg);
    border: 1px solid var(--color-border-darker);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }
  
  .card-header {
    padding: 0.75rem;
    border-bottom: 1px solid var(--color-border-darker);
    background-color: rgba(0, 0, 0, 0.02);
  }
  
  .card-body {
    padding: 1rem;
  }
  
  .card-body.compact {
    padding: 0.5rem;
  }
  
  .margin-bottom {
    margin-bottom: 1.5rem;
  }
  
  .margin-top {
    margin-top: 1.5rem;
  }
  
  .txt-h3 {
    font-size: 1rem;
    font-weight: 500;
    margin: 0;
    color: var(--color-text);
  }
  
  .txt-h4 {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    color: var(--color-text);
  }
  
  .flex-grow {
    flex: 1;
  }
  
  .flex-wrap {
    flex-wrap: wrap;
  }
  
  .table {
    border-collapse: collapse;
    width: 100%;
  }
  
  .table th, .table td {
    padding: 0.5rem;
    border-bottom: 1px solid var(--color-border-darker);
  }
  
  .compact .table th, .compact .table td {
    padding: 0.25rem 0.5rem;
  }
  
  .compact-table .table th, .compact-table .table td {
    padding: 0.25rem 0.5rem;
  }
  
  .table th {
    text-align: left;
    font-weight: normal;
  }
  
  .txt-right {
    text-align: right;
  }
  
  .avatar-xs {
    width: 18px;
    height: 18px;
    font-size: 9px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    overflow: hidden;
    background: var(--color-border-darker);
    border: 1px solid var(--color-border-darker);
  }
  
  .avatar-xs img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .current-user {
    background-color: rgba(0, 100, 255, 0.1);
  }
  
  .table-container {
    padding: 0.25rem 0;
  }
  
  .compact-rows th, .compact-rows td {
    padding: 0.25rem 0.5rem;
  }
  
  /* Stats page link styles */
  .full-width a {
    color: #000;
    text-decoration: none;
  }
  
  .full-width a:visited {
    color: #000;
  }
  
  .full-width a:hover {
    text-decoration: underline;
  }
</style> 