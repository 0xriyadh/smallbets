<% @page_title = "Room Stats" %>
<% @body_class = "stats-page" %>

<% content_for :head do %>
  <%= stylesheet_link_tag "application/stats" %>
<% end %>

<% content_for :nav do %>
  <div class="flex-item-justify-start flex gap">
    <%= link_to stats_path, class: "btn" do %>
      <%= image_tag("arrow-left.svg", aria: { hidden: "true" }, size: 20) %>
      <span>Back to Stats</span>
    <% end %>
    <%= link_to stats_rooms_path, class: "btn d-hotwire-native-none" do %>
      <%= image_tag("refresh.svg", aria: { hidden: "true" }, size: 20) %>
      <span class="for-screen-reader">Refresh stats</span>
    <% end %>
  </div>
<% end %>

<section class="full-width" style="margin-top: 4rem;">
  <div class="margin-block">
    <div class="card">
      <div class="card-header">
        <h2 class="txt-h3 margin-none">Top Rooms</h2>
      </div>
      <div class="card-body compact">
        <div class="overflow-x-auto">
          <table class="table full-width">
            <thead>
              <tr>
                <th style="width: 20px;"></th>
                <th></th>
                <th class="txt-left">Creator</th>
                <th class="txt-left">Top Talker</th>
                <th class="txt-right" style="width: 80px;">Messages</th>
              </tr>
            </thead>
            <tbody>
              <% if @rooms.any? %>
                <% @rooms.each_with_index do |room, index| %>
                  <tr>
                    <td class="txt-right txt-small txt-faded" style="width: 20px;"><%= index + 1 %></td>
                    <td>
                      <%= link_to room_path(room), style: "text-decoration: none;" do %>
                        <span class="txt-truncate"><%= room.name %></span>
                      <% end %>
                    </td>
                    <td>
                      <% if room.creator %>
                        <%= link_to user_path(room.creator, from: "/stats/rooms"), class: "flex align-center hover-target", style: "text-decoration: none; gap: 4px; min-width: 0;" do %>
                          <% if room.creator.avatar.attached? %>
                            <div class="avatar avatar-xs">
                              <%= image_tag room.creator.avatar, alt: room.creator.name, loading: "lazy" %>
                            </div>
                          <% else %>
                            <div class="avatar avatar-xs">
                              <%= room.creator.name.first.upcase %>
                            </div>
                          <% end %>
                          <span class="txt-truncate"><%= room.creator.name %></span>
                        <% end %>
                      <% else %>
                        <span class="txt-faded">Unknown</span>
                      <% end %>
                    </td>
                    <td>
                      <% if top_talker = @top_talkers[room.id] %>
                        <%= link_to user_path(top_talker, from: "/stats/rooms"), class: "flex align-center hover-target", style: "text-decoration: none; gap: 4px; min-width: 0;" do %>
                          <% if top_talker.avatar.attached? %>
                            <div class="avatar avatar-xs">
                              <%= image_tag top_talker.avatar, alt: top_talker.name, loading: "lazy" %>
                            </div>
                          <% else %>
                            <div class="avatar avatar-xs">
                              <%= top_talker.name.first.upcase %>
                            </div>
                          <% end %>
                          <span class="txt-truncate"><%= top_talker.name %></span>
                        <% end %>
                      <% else %>
                        <span class="txt-faded">None</span>
                      <% end %>
                    </td>
                    <td class="txt-right" style="width: 80px;">
                      <%= number_with_delimiter(room.message_count) %>
                    </td>
                  </tr>
                <% end %>
              <% else %>
                <tr>
                  <td colspan="5" class="txt-center">No open rooms yet</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>
