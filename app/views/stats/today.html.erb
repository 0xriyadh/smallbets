<% @page_title = "Daily Stats" %>
<% @body_class = "stats-page" %>

<% content_for :head do %>
  <%= stylesheet_link_tag "application/stats" %>
<% end %>

<% content_for :nav do %>
  <div class="flex-item-justify-start flex gap">
    <%= link_to stats_path, class: "btn" do %>
      <%= image_tag("arrow-left.svg", aria: { hidden: "true" }, size: 20) %>
      <span>Back to Stats</span>
    <% end %>
    <%= link_to stats_daily_path, class: "btn d-hotwire-native-none" do %>
      <%= image_tag("refresh.svg", aria: { hidden: "true" }, size: 20) %>
      <span class="for-screen-reader">Refresh stats</span>
    <% end %>
  </div>
<% end %>

<section class="full-width" style="margin-top: 2rem;">
  <% 
    # Group days by month
    days_by_month = @days.group_by do |day|
      date = Date.parse(day)
      "#{date.year}-#{date.month.to_s.rjust(2, '0')}"
    end
    
    # Sort months in descending order
    sorted_months = days_by_month.keys.sort.reverse
  %>
  
  <% sorted_months.each do |month_key| %>
    <% 
      year, month = month_key.split('-')
      month_name = Date.new(year.to_i, month.to_i, 1).strftime("%B %Y") 
      
      # Sort days within month in descending order (31st to 1st)
      days_in_month = days_by_month[month_key].sort.reverse
    %>
    <h2 class="section-heading" style="margin-top: 2rem;"><%= month_name %></h2>
    <div class="stats-grid margin-block">
      <% days_in_month.each do |day| %>
        <div class="card grid-card">
          <div class="card-header">
            <h2 class="txt-h3 margin-none"><%= day %></h2>
          </div>
          <div class="card-body compact">
            <div class="overflow-x-auto">
              <table class="table full-width">
                <tbody>
                  <% if @daily_stats[day].present? %>
                    <% @daily_stats[day].each_with_index do |user, index| %>
                      <% is_current = user.id == Current.user&.id %>
                      <tr class="<%= 'current-user' if is_current %>">
                        <td class="txt-right txt-small txt-faded" style="width: 20px;"><%= index + 1 %></td>
                        <td>
                          <div class="flex gap-inline align-center">
                            <%= link_to user_path(user, from: "/stats/daily"), class: "flex align-center hover-target", style: "text-decoration: none; gap: 4px; min-width: 0;" do %>
                              <% if user.avatar.attached? %>
                                <div class="avatar avatar-xs">
                                  <%= image_tag user.avatar, alt: user.name, loading: "lazy" %>
                                </div>
                              <% else %>
                                <div class="avatar avatar-xs">
                                  <%= user.name.first.upcase %>
                                </div>
                              <% end %>
                              <span class="txt-truncate"><%= user.name %></span>
                            <% end %>
                          </div>
                        </td>
                        <td class="txt-right">
                          <%= number_with_delimiter(user.message_count) %>
                        </td>
                      </tr>
                    <% end %>
                  <% else %>
                    <tr>
                      <td colspan="3" class="txt-center">No messages yet</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</section> 